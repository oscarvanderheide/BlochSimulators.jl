<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>MR Fingerprinting Dictionary Generation · BlochSimulators.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">BlochSimulators.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../overview/">Overview</a></li><li><span class="tocitem">Examples</span><ul><li class="is-active"><a class="tocitem" href>MR Fingerprinting Dictionary Generation</a></li><li><a class="tocitem" href="../signal/">Simulate MR Signal</a></li><li><a class="tocitem" href="../adiabatic/">Adiabatic inversion</a></li></ul></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>MR Fingerprinting Dictionary Generation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>MR Fingerprinting Dictionary Generation</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/oscarvanderheide/BlochSimulators.jl/blob/main/docs/src/dictionary.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="MR-Fingerprinting-Dictionary-Generation"><a class="docs-heading-anchor" href="#MR-Fingerprinting-Dictionary-Generation">MR Fingerprinting Dictionary Generation</a><a id="MR-Fingerprinting-Dictionary-Generation-1"></a><a class="docs-heading-anchor-permalink" href="#MR-Fingerprinting-Dictionary-Generation" title="Permalink"></a></h1><pre><code class="language-julia hljs">using Pkg;
Pkg.activate(&quot;docs&quot;);</code></pre><p>In this example we demonstrate how to generate an MR Fingerprinting dictionary using a FISP type sequence</p><pre><code class="language-julia hljs">using BlochSimulators
using ComputationalResources
using StructArrays</code></pre><p>First, construct a FISP sequence struct (see <code>src/sequences/fisp.jl</code> for which fields are necessary and which constructors exist)</p><pre><code class="language-julia hljs">nTR = 1000; # nr of TRs used in the simulation
RF_train = LinRange(1, 90, nTR) |&gt; collect; # flip angle train
TR, TE, TI = 0.010, 0.005, 0.100; # repetition time, echo time, inversion delay
max_state = 25; # maximum number of configuration states to keep track of

sequence = FISP2D(RF_train, TR, TE, max_state, TI);</code></pre><p>Next, set the desired input parameters</p><pre><code class="language-julia hljs">T₁ = 0.500:0.10:5.0; # T₁ range
T₂ = 0.025:0.05:1.0; # T₂ range

parameters = map(T₁T₂, Iterators.product(T₁, T₂)); # produce all parameter pairs
parameters = filter(p -&gt; (p.T₁ &gt; p.T₂), parameters); # remove pairs with T₂ ≤ T₁
parameters = StructVector(parameters)

println(&quot;Length parameters: $(length(parameters))&quot;)</code></pre><p>Now we can perform the simulations using different hardware resources</p><p>Note that the first time a function is called in a Julia session, a precompilation procedure starts and the runtime for subsequent function calls are significantly faster</p><p>First, we simply simulate a dictionary using single-threaded CPU mode:</p><pre><code class="language-julia hljs">@time dictionary = simulate_magnetization(CPU1(), sequence, parameters);</code></pre><p>Note that the first time a function is called, Julia&#39;s JIT compiler performs a compilation procedure. The second time a functio is called with arguments of similar types, the pre-compiled version is called immediatly.</p><pre><code class="language-julia hljs">@time dictionary = simulate_magnetization(CPU1(), sequence, parameters);</code></pre><p>To use multiple threads, Julia must be started with the <code>--threads=auto</code> flag (or some integer instead of <code>auto</code>). Then, we can simulate in a multi-threaded fashion with the following syntax:</p><pre><code class="language-julia hljs">println(&quot;Current number of threads: $(Threads.nthreads())&quot;)
@time dictionary = simulate_magnetization(CPUThreads(), sequence, parameters);</code></pre><p>For distributed CPU mode, use the Distribute packages (ships with Julia) to add workers first</p><pre><code class="language-julia hljs">using Distributed
addprocs(4, exeflags=&quot;--project=.&quot;)</code></pre><p>Alternatively, if you can ssh into some other machine, you can add CPUs from that machine as follows: addprocs([(&quot;12.345.67.89&quot;, 4)], exeflags=&quot;–project=.&quot;)</p><p>Or, if you want to run this code on cluster with a queuing system, use ClusterManagers package.</p><p>After workers have been added, load BlochSimulators on all workers and then start a distributed dictionary generation with:</p><pre><code class="language-julia hljs">@everywhere using BlochSimulators

println(&quot;Current number of workers: $(nworkers())&quot;)
@time dictionary = simulate_magnetization(CPUProcesses(), sequence, parameters);</code></pre><p>To perform simulations on GPU, we first convert the sequence and parameters to single precision and then send them to the gpu</p><pre><code class="language-julia hljs">cu_sequence = sequence |&gt; f32 |&gt; gpu;
cu_parameters = parameters |&gt; f32 |&gt; gpu;</code></pre><p>Remember, the first time a compilation procedure takes place which, especially on GPU, can take some time.</p><pre><code class="language-julia hljs">println(&quot;Active CUDA device:&quot;);
BlochSimulators.CUDA.device();

@time dictionary = simulate_magnetization(CUDALibs(), cu_sequence, cu_parameters);</code></pre><p>Call the pre-compiled version</p><pre><code class="language-julia hljs">@time dictionary = simulate_magnetization(CUDALibs(), cu_sequence, cu_parameters);</code></pre><p>Increase the number of parameters:</p><pre><code class="language-julia hljs">T₁ = rand(500_000)
T₂ = 0.1 * T₁
cu_parameters = (@parameters T₁ T₂) |&gt; f32 |&gt; gpu

@time dictionary = simulate_magnetization(CUDALibs(), cu_sequence, cu_parameters);</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../overview/">« Overview</a><a class="docs-footer-nextpage" href="../signal/">Simulate MR Signal »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Monday 5 August 2024 11:57">Monday 5 August 2024</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
